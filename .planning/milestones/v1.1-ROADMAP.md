# Milestone v1.1: OAuth2 Support

**Status:** ✅ SHIPPED 2026-02-06
**Phases:** 5-7
**Total Plans:** 3

## Overview

Add OAuth2 browser-based login flow for personal Gmail accounts alongside existing service account auth. Users can now authenticate with `gsuite login` using their personal Gmail — no service account needed.

## Phases

### Phase 5: OAuth2 Core

**Goal**: Implement token storage, browser opener, and OAuth2 authorization code flow with PKCE
**Depends on**: v1.0 complete
**Plans**: 1 plan

Plans:
- [x] 05-01: OAuth2 PKCE flow + token storage

**Details:**
- Token persistence module with XDG-compatible path (~/.config/gsuite/token.json)
- Full OAuth2 PKCE flow: code verifier/challenge generation, local HTTP callback server on :8089, browser open, token exchange
- OAuth2-based Gmail service creation from stored tokens
- Secure file permissions (0600 token, 0700 directory)
- Cross-platform browser open (xdg-open, open, rundll32 with URL-print fallback)

### Phase 6: Auth Dispatcher

**Goal**: Refactor auth.go to auto-detect credential type from JSON and branch between service account / OAuth flows
**Depends on**: Phase 5
**Plans**: 1 plan

Plans:
- [x] 06-01: Credential type detection + auth dispatcher

**Details:**
- detectCredentialType parses JSON to identify service_account, installed, or web credential formats
- extractOAuth2ClientCreds parses client ID/secret from installed/web JSON keys
- NewGmailService transparently dispatches between service account and OAuth2 flows
- OAuth2 path returns actionable "run gsuite login" error when no cached token
- UserEmail validation moved to service account path only

### Phase 7: CLI Integration

**Goal**: Add `login` command, remove `--user` guards from 7 command files, update help text
**Depends on**: Phase 6
**Plans**: 1 plan

Plans:
- [x] 07-01: Login/logout commands + --user guard removal

**Details:**
- `gsuite login` triggers OAuth2 PKCE browser flow, saves token, prints authenticated email
- `gsuite logout` removes cached token file
- Removed 18 `--user` empty-check guards from 7 command files
- Updated root help text and --user flag description to document both auth methods
- auth.Login() encapsulates full flow including profile fetch for email display

---

## Milestone Summary

**Key Decisions:**
- OAuth2Config struct mirrors auth.Config pattern for parallel auth paths
- PKCE with S256 challenge method for public client security
- Single file refactor for auth dispatcher — all detection logic in auth.go
- OAuth2 path returns error when no token rather than auto-triggering browser flow
- auth.Login() encapsulates full flow rather than exposing intermediate steps to CLI layer

**Issues Resolved:**
- None — clean execution across all 3 phases

**Issues Deferred:**
- None

**Technical Debt Incurred:**
- None identified

---

_For current project status, see .planning/ROADMAP.md_
