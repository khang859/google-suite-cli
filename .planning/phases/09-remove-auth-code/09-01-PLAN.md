---
phase: 09-remove-auth-code
plan: 01
type: execute
depends_on: []
files_modified: [internal/auth/auth.go, internal/auth/oauth2.go, cmd/login.go]
---

<objective>
Strip service account JWT auth and device flow code from internal/auth, simplify login command to PKCE-only.

Purpose: Simplify auth to a single path (OAuth2 PKCE browser flow) — fewer code paths, less maintenance, cleaner mental model.
Output: auth package with no service account or device flow code; login command without --no-browser flag.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@internal/auth/auth.go
@internal/auth/oauth2.go
@internal/auth/token.go
@cmd/login.go
@cmd/root.go

**Constraining decisions:**
- Milestone v2.0 goal: "Strip auth down to OAuth2 PKCE only"
- Phase 10 handles CLI flag removal (--credentials-file, --user) and subcommand updates — do NOT touch those here
- token.go stays unchanged (still needed for OAuth2 token persistence)

**What to remove:**
- Service account: `credentialType` enum, `detectCredentialType()`, `extractOAuth2ClientCreds()`, `newServiceAccountGmailService()`, `LoadCredentials()` (service account paths), `Config.UserEmail`
- Device flow: `DeviceAuthenticate()` method, `--no-browser` flag, `noBrowser` parameter in `Login()`
- Credential dispatching: `NewGmailService()` no longer needs to detect type and dispatch

**What to keep:**
- OAuth2 PKCE browser flow (`Authenticate()` method)
- `OAuth2Config` struct and `NewOAuth2Config()`
- Token persistence (token.go)
- `NewGmailService` on `OAuth2Config` (creates Gmail service from token)
- `openBrowser()`, PKCE helpers
</context>

<tasks>

<task type="auto">
  <name>Task 1: Strip auth.go to OAuth2-only</name>
  <files>internal/auth/auth.go</files>
  <action>
Rewrite auth.go to remove all service account code:

1. Remove `credentialType` enum and constants (`credServiceAccount`, `credOAuth2Client`)
2. Remove `detectCredentialType()` function
3. Remove `extractOAuth2ClientCreds()` function — move to a private helper since it's still needed by Login/NewGmailService
4. Remove `newServiceAccountGmailService()` function entirely
5. Simplify `Config` struct: remove `UserEmail` field (not needed for OAuth2). Keep `CredentialsFile` and `CredentialsJSON` for now (Phase 10 removes CLI flags)
6. Simplify `LoadCredentials()`: keep the same credential loading priority but remove the error message mentioning service accounts
7. Simplify `NewGmailService()`: remove credential type detection and dispatch switch. It should: load credentials → extract OAuth2 client creds → load cached token → create Gmail service. Basically inline what `newOAuth2GmailService` does.
8. Remove `newOAuth2GmailService()` (merged into `NewGmailService`)
9. Simplify `Login()`: remove `noBrowser` parameter, remove credential type check (no more "login is only for OAuth2" guard since everything is OAuth2 now), always use browser PKCE flow.

Keep `extractOAuth2ClientCreds` as a private helper (still needed by both `Login` and `NewGmailService`).
  </action>
  <verify>go build ./... succeeds with no errors</verify>
  <done>auth.go has no service account references, no device flow references, no credential type detection. Login() takes (ctx, credJSON) only. NewGmailService() goes straight to OAuth2 token path.</done>
</task>

<task type="auto">
  <name>Task 2: Strip device flow from oauth2.go</name>
  <files>internal/auth/oauth2.go</files>
  <action>
Remove the `DeviceAuthenticate()` method from OAuth2Config. This is the RFC 8628 device authorization flow used for headless environments.

Remove only the `DeviceAuthenticate` method. Keep everything else:
- `OAuth2Config` struct and `NewOAuth2Config()`
- `Authenticate()` (browser PKCE flow)
- `NewGmailService()` on OAuth2Config
- All PKCE helpers (`generateCodeVerifier`, `generateCodeChallenge`, `generateState`)
- `openBrowser()`
  </action>
  <verify>go build ./... succeeds with no errors</verify>
  <done>oauth2.go has no DeviceAuthenticate method. Only browser PKCE flow remains.</done>
</task>

<task type="auto">
  <name>Task 3: Clean up login command</name>
  <files>cmd/login.go</files>
  <action>
1. Remove `noBrowser` variable declaration
2. Remove `--no-browser` flag registration from `init()`
3. Update `loginCmd` Long description: remove mentions of --no-browser, device authorization flow, headless environments
4. Update `loginCmd` Example: remove the --no-browser example
5. Update `runLogin`: call `auth.Login(ctx, credJSON)` without noBrowser parameter (signature changed in Task 1)
6. Keep logout command unchanged (still works the same)
  </action>
  <verify>go build ./... succeeds with no errors</verify>
  <done>login command has no --no-browser flag, no device flow references. Login just does browser PKCE.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build ./...` succeeds
- [ ] `grep -r "service_account\|ServiceAccount\|JWTConfig\|DeviceAuth\|DeviceAuthenticate\|noBrowser\|no-browser\|device" internal/auth/ cmd/login.go` returns no matches
- [ ] `grep -r "credServiceAccount\|credOAuth2Client\|credentialType\|detectCredentialType\|newServiceAccountGmailService" internal/auth/` returns no matches
</verification>

<success_criteria>

- All service account auth code removed from internal/auth/
- Device authorization flow removed from oauth2.go
- Login command simplified to browser PKCE only
- No build errors
- No references to removed concepts remain in modified files
</success_criteria>

<output>
After completion, create `.planning/phases/09-remove-auth-code/09-01-SUMMARY.md`
</output>
