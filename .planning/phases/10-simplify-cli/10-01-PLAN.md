---
phase: 10-simplify-cli
plan: 01
type: execute
depends_on: []
files_modified: [cmd/root.go, internal/auth/auth.go, cmd/login.go, cmd/whoami.go, cmd/messages.go, cmd/threads.go, cmd/labels.go, cmd/drafts.go, cmd/search.go, cmd/send.go]
---

<objective>
Remove --credentials-file and --user flags, simplify auth.Config to credentials-free for subcommands, update all subcommands to use simplified auth API, and improve error messages for missing login.

Purpose: Complete v2.0 auth simplification — after Phase 9 stripped service account and device flow code, this phase removes the now-unnecessary CLI flags and simplifies the subcommand auth boilerplate.
Output: Clean CLI with no legacy flags, simplified auth API, clear "run gsuite login" error messages.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-remove-auth-code/09-01-SUMMARY.md

# Key files:
@cmd/root.go
@internal/auth/auth.go

**Tech stack available:** Go, Cobra, Google Gmail API, OAuth2 PKCE
**Established patterns:** Single OAuth2 PKCE auth path, no credential type detection needed
**Constraining decisions:**
- Phase 9: Kept UserEmail in Config struct (deprecated) to avoid touching all subcommand callers — this phase removes it
</context>

<tasks>

<task type="auto">
  <name>Task 1: Simplify auth package and root command flags</name>
  <files>internal/auth/auth.go, cmd/root.go</files>
  <action>
**internal/auth/auth.go:**
- Remove Config struct entirely — it's no longer needed since subcommands don't pass credentials
- Change LoadCredentials() to take no arguments: `func LoadCredentials() ([]byte, error)`. It should only check env vars: GOOGLE_CREDENTIALS (raw JSON) then GOOGLE_APPLICATION_CREDENTIALS (file path). Error message should say: `no OAuth2 client credentials found: set GOOGLE_CREDENTIALS env var (JSON) or GOOGLE_APPLICATION_CREDENTIALS env var (file path)`
- Change NewGmailService signature to `func NewGmailService(ctx context.Context) (*gmail.Service, error)`. Inside, call LoadCredentials() with no args. Keep the same token loading and "run gsuite login" error message.
- Login() already takes credJSON directly — no change needed there, but its callers (login.go) will need to call LoadCredentials() directly instead of building a Config

**cmd/root.go:**
- Remove the `credentialsFile` and `userEmail` variables
- Remove the two PersistentFlags lines for `--credentials-file` and `--user`
- Remove the GetCredentialsFile() and GetUserEmail() functions
- Update root command Long description: remove "Service account with domain-wide delegation" line, change to single-line about OAuth2 login. Something like: "Authenticate with 'gsuite login' to get started."
  </action>
  <verify>go build -o gsuite . compiles without errors</verify>
  <done>Config struct removed from auth package. LoadCredentials() and NewGmailService() take no Config argument. --credentials-file and --user flags removed from root. GetCredentialsFile() and GetUserEmail() removed. Builds cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Update all subcommands to simplified auth API</name>
  <files>cmd/login.go, cmd/whoami.go, cmd/messages.go, cmd/threads.go, cmd/labels.go, cmd/drafts.go, cmd/search.go, cmd/send.go</files>
  <action>
**All subcommands except login.go** (whoami, messages, threads, labels, drafts, search, send):
Every run function has this pattern to replace:
```go
credFile := GetCredentialsFile()
user := GetUserEmail()
// ...
cfg := auth.Config{
    CredentialsFile: credFile,
    UserEmail:       user,
}
// ...
service, err := auth.NewGmailService(ctx, cfg)
```
Replace with:
```go
service, err := auth.NewGmailService(ctx)
```
Remove the credFile and user variable declarations. Remove the cfg variable. Pass ctx directly to NewGmailService. Remove any custom error wrapping that references --credentials-file (like in whoami.go's `if credFile == ""` check) — NewGmailService now returns clear error messages.

**cmd/login.go:**
Replace:
```go
credFile := GetCredentialsFile()
cfg := auth.Config{
    CredentialsFile: credFile,
}
credJSON, err := auth.LoadCredentials(cfg)
```
With:
```go
credJSON, err := auth.LoadCredentials()
```
Update help text: remove mention of --credentials-file flag from Long description and Example. Long should say credentials come from GOOGLE_CREDENTIALS or GOOGLE_APPLICATION_CREDENTIALS env vars. Example should show just `gsuite login`.

**cmd/whoami.go:**
Update Long description — remove "user being impersonated via domain-wide delegation" and references to service account. It should say something like "Show the Gmail profile of the logged-in user."

Count: 20 sites use GetCredentialsFile(), 19 use GetUserEmail(), 20 use auth.Config{}. All must be updated.
  </action>
  <verify>go build -o gsuite . && ./gsuite --help (should show no --credentials-file or --user flags) && ./gsuite login --help (should not mention --credentials-file)</verify>
  <done>All 8 subcommand files updated. No references to GetCredentialsFile, GetUserEmail, or auth.Config remain in cmd/. go build succeeds. --help shows only --verbose and --format as persistent flags.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `go build -o gsuite .` succeeds without errors
- [ ] `./gsuite --help` shows only --verbose and --format persistent flags (no --credentials-file, no --user)
- [ ] `./gsuite login --help` does not reference --credentials-file
- [ ] `./gsuite whoami --help` does not reference "domain-wide delegation" or "impersonate"
- [ ] `grep -r "GetCredentialsFile\|GetUserEmail\|auth\.Config" cmd/` returns nothing
- [ ] `grep -r "credentials-file\|--user" cmd/root.go` returns nothing
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors
- CLI flags simplified to --verbose and --format only
- Auth package has no Config struct
- All subcommands use NewGmailService(ctx) directly
- Phase 10 complete — v2.0 Auth Simplification milestone done
</success_criteria>

<output>
After completion, create `.planning/phases/10-simplify-cli/10-01-SUMMARY.md`
</output>
