---
phase: 11-multi-account
plan: 01
type: execute
depends_on: []
files_modified: [internal/auth/accounts.go, internal/auth/token.go]
---

<objective>
Create the AccountStore type for managing multiple authenticated Gmail accounts and refactor token storage to support per-account token files.

Purpose: Build the storage foundation — accounts.json manifest and tokens/ directory — that all subsequent multi-account plans depend on.
Output: New accounts.go with full CRUD, refactored token.go with per-account paths, both with backward-compatible legacy helpers.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/milestones/v3.0-ROADMAP.md
@internal/auth/token.go

**Tech stack available:** Go, Cobra, Google Gmail API, OAuth2 PKCE
**Established patterns:** XDG-compatible config at ~/.config/gsuite/, 0700 dir + 0600 file permissions, JSON serialization
**Constraining decisions:**
- Current token path is ~/.config/gsuite/token.json (single file)
- Email is only known after OAuth2 login completes (fetched via profile API)
- Must preserve legacy TokenPath/LoadToken/SaveToken for migration plan (11-02)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AccountStore type with CRUD operations</name>
  <files>internal/auth/accounts.go</files>
  <action>
Create `internal/auth/accounts.go` with:

**Types:**
```go
type AccountEntry struct {
    Email   string    `json:"email"`
    AddedAt time.Time `json:"added_at"`
}

type AccountStore struct {
    Active   string         `json:"active"`
    Accounts []AccountEntry `json:"accounts"`
}
```

**Functions:**
- `AccountStorePath() (string, error)` — returns `~/.config/gsuite/accounts.json`, creates parent dir if needed (same pattern as TokenPath)
- `LoadAccountStore() (*AccountStore, error)` — reads and unmarshals accounts.json. If file doesn't exist, returns empty store (not error): `&AccountStore{}`
- `(s *AccountStore) Save() error` — marshals and writes to accounts.json with 0600 permissions
- `(s *AccountStore) AddAccount(email string) error` — adds account if not already present, sets as active. If already present, just updates active.
- `(s *AccountStore) RemoveAccount(email string) error` — removes account entry. If removed account was active, set active to first remaining account or "" if none left.
- `(s *AccountStore) SetActive(email string) error` — sets active to given email. Error if email not in accounts list.
- `(s *AccountStore) GetActive() (string, error)` — returns active email. If active is "" but exactly one account exists, return that one. If multiple and no active set, return error.
- `(s *AccountStore) HasAccount(email string) bool` — check if account exists
- `(s *AccountStore) List() []AccountEntry` — return copy of accounts slice

All email comparisons should be case-insensitive (strings.EqualFold).
  </action>
  <verify>go build -o gsuite . compiles without errors</verify>
  <done>accounts.go created with AccountStore type and full CRUD. All email comparisons case-insensitive. File loads gracefully when accounts.json doesn't exist.</done>
</task>

<task type="auto">
  <name>Task 2: Refactor token storage for per-account tokens</name>
  <files>internal/auth/token.go</files>
  <action>
Refactor `internal/auth/token.go`:

**Keep existing functions** (renamed as legacy):
- Rename `TokenPath()` to `LegacyTokenPath()` — same behavior, returns `~/.config/gsuite/token.json`
- Rename `SaveToken()` to `saveLegacyToken()` (unexport, only used by migration)
- Rename `LoadToken()` to `LoadLegacyToken()` — keep exported for migration

**Add new per-account functions:**
- `TokensDir() (string, error)` — returns `~/.config/gsuite/tokens/`, creates dir with 0700 if needed
- `TokenPathFor(email string) (string, error)` — returns `~/.config/gsuite/tokens/<email>.json`. Validate email is non-empty.
- `SaveTokenFor(email string, token *oauth2.Token) error` — write token to per-account path with 0600 permissions
- `LoadTokenFor(email string) (*oauth2.Token, error)` — read token from per-account path. Return os.ErrNotExist if not found.
- `DeleteTokenFor(email string) error` — remove per-account token file. No error if file doesn't exist (use os.Remove + os.IsNotExist check).

Email in file paths should be used as-is (lowercase is conventional for Gmail addresses).
  </action>
  <verify>go build -o gsuite . compiles without errors</verify>
  <done>token.go refactored with legacy functions preserved and new per-account TokenPathFor/SaveTokenFor/LoadTokenFor/DeleteTokenFor added. Tokens stored under ~/.config/gsuite/tokens/ directory.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `go build -o gsuite .` succeeds without errors
- [ ] `grep -r "AccountStore" internal/auth/accounts.go` shows the type
- [ ] `grep -r "TokenPathFor\|SaveTokenFor\|LoadTokenFor\|DeleteTokenFor" internal/auth/token.go` shows all per-account functions
- [ ] `grep -r "LegacyTokenPath\|LoadLegacyToken" internal/auth/token.go` shows legacy functions preserved
- [ ] No existing command behavior is broken (all still compile)
</verification>

<success_criteria>
- AccountStore with full CRUD in accounts.go
- Per-account token storage in token.go
- Legacy token functions preserved for migration
- Clean compilation, no behavior changes to existing commands yet
</success_criteria>

<output>
After completion, create `.planning/phases/11-multi-account/11-01-SUMMARY.md`
</output>
