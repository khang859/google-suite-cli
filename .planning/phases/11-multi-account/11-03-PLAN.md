---
phase: 11-multi-account
plan: 03
type: execute
depends_on: [11-02]
files_modified: [cmd/accounts.go, cmd/root.go, cmd/login.go]
---

<objective>
Add the `accounts` command group (list, switch, remove), the `--account` global flag, and update login/logout for multi-account behavior.

Purpose: Give users the CLI interface to manage multiple accounts.
Output: `gsuite accounts list|switch|remove` commands, `--account` flag on all commands, updated login/logout.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.0-ROADMAP.md
@.planning/phases/11-multi-account/11-01-PLAN.md
@.planning/phases/11-multi-account/11-02-PLAN.md
@cmd/root.go
@cmd/login.go

**Tech stack available:** Go, Cobra CLI, internal/auth package with AccountStore
**Established patterns:** Cobra subcommand pattern, GetOutputFormat()/GetVerbose() getters in root.go
**Constraining decisions:**
- Plan 11-01: AccountStore with AddAccount/RemoveAccount/SetActive/GetActive/List/HasAccount
- Plan 11-02: Login() adds to store, NewGmailService(ctx, account) resolves account
- Token deletion: DeleteTokenFor(email) in token.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add --account global flag to root command</name>
  <files>cmd/root.go</files>
  <action>
Add to cmd/root.go:

1. New variable: `var accountEmail string`
2. New persistent flag in init(): `rootCmd.PersistentFlags().StringVar(&accountEmail, "account", "", "Use specific account email")`
3. New getter: `func GetAccountEmail() string { return accountEmail }`

Also check for GSUITE_ACCOUNT env var fallback:
```go
func GetAccountEmail() string {
    if accountEmail != "" {
        return accountEmail
    }
    return os.Getenv("GSUITE_ACCOUNT")
}
```
  </action>
  <verify>go build -o gsuite . && ./gsuite --help shows --account flag</verify>
  <done>--account flag added to root command with env var fallback via GetAccountEmail().</done>
</task>

<task type="auto">
  <name>Task 2: Create accounts command group</name>
  <files>cmd/accounts.go</files>
  <action>
Create `cmd/accounts.go` with three subcommands under `accounts` parent:

**Parent command:**
```go
var accountsCmd = &cobra.Command{
    Use:   "accounts",
    Short: "Manage authenticated Gmail accounts",
    Long:  "List, switch between, or remove authenticated Gmail accounts.",
}
```

**accounts list:**
```go
var accountsListCmd = &cobra.Command{
    Use:   "list",
    Short: "List all authenticated accounts",
    RunE:  runAccountsList,
}
```
`runAccountsList`: Load AccountStore. If no accounts, print "No authenticated accounts. Run 'gsuite login' to add one." For each account, print with `*` prefix if active, space otherwise. Format: `* user@gmail.com  (added 2025-01-15)`. JSON format should output array of `{email, added_at, active}`.

**accounts switch:**
```go
var accountsSwitchCmd = &cobra.Command{
    Use:   "switch <email>",
    Short: "Switch the active account",
    Args:  cobra.ExactArgs(1),
    RunE:  runAccountsSwitch,
}
```
`runAccountsSwitch`: Load store, call SetActive(args[0]), save. Print "Switched to <email>".

**accounts remove:**
```go
var accountsRemoveCmd = &cobra.Command{
    Use:   "remove <email>",
    Short: "Remove an authenticated account",
    Args:  cobra.ExactArgs(1),
    RunE:  runAccountsRemove,
}
```
`runAccountsRemove`: Load store, call RemoveAccount(args[0]), save. Also call DeleteTokenFor(email) to remove the token file. Print "Removed account <email>".

Register in init():
```go
func init() {
    accountsCmd.AddCommand(accountsListCmd)
    accountsCmd.AddCommand(accountsSwitchCmd)
    accountsCmd.AddCommand(accountsRemoveCmd)
    rootCmd.AddCommand(accountsCmd)
}
```
  </action>
  <verify>go build -o gsuite . && ./gsuite accounts --help && ./gsuite accounts list --help</verify>
  <done>accounts command group created with list, switch, remove subcommands. All registered under root.</done>
</task>

<task type="auto">
  <name>Task 3: Update login and logout for multi-account</name>
  <files>cmd/login.go</files>
  <action>
**Update login command:**
- Update Long description to mention multi-account: "Authenticate with Gmail using OAuth2. You can login with multiple accounts. The most recently logged-in account becomes the active account."
- runLogin already calls auth.Login() which now handles account store â€” no logic change needed
- After login, print "Logged in as <email>" (already does this)
- Add a hint if multiple accounts: load store after login, if len > 1, print "Active account set to <email>. Use 'gsuite accounts list' to see all accounts."

**Update logout command:**
- Current: removes single token.json
- New behavior: if arg provided (`gsuite logout <email>`), remove that specific account. If no arg, remove the active account.
- Change Args from cobra.NoArgs to cobra.MaximumNArgs(1)
- runLogout logic:
  1. Load account store
  2. Determine email: if args[0] provided use it, else use store.GetActive()
  3. Call store.RemoveAccount(email), store.Save()
  4. Call auth.DeleteTokenFor(email)
  5. Print "Logged out of <email>"
  6. If store still has accounts, print "Active account: <new active>" or "No remaining accounts"
- Update Long description to mention optional email argument
  </action>
  <verify>go build -o gsuite . && ./gsuite login --help && ./gsuite logout --help</verify>
  <done>login shows multi-account hint when >1 accounts. logout supports optional email argument and removes from account store.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `go build -o gsuite .` succeeds
- [ ] `./gsuite --help` shows --account flag
- [ ] `./gsuite accounts list --help` works
- [ ] `./gsuite accounts switch --help` shows <email> argument
- [ ] `./gsuite accounts remove --help` shows <email> argument
- [ ] `./gsuite login --help` mentions multiple accounts
- [ ] `./gsuite logout --help` mentions optional email argument
</verification>

<success_criteria>
- accounts command group with list/switch/remove works
- --account global flag with GSUITE_ACCOUNT env var fallback
- login/logout updated for multi-account
- All commands compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/11-multi-account/11-03-SUMMARY.md`
</output>
