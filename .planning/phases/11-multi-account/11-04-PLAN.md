---
phase: 11-multi-account
plan: 04
type: execute
depends_on: [11-03]
files_modified: [cmd/messages.go, cmd/threads.go, cmd/labels.go, cmd/drafts.go, cmd/search.go, cmd/send.go, cmd/whoami.go]
---

<objective>
Update all command files to pass the --account flag through to auth.NewGmailService(), completing the multi-account integration.

Purpose: Wire every command to the multi-account auth API so users can target any account via --account flag.
Output: All 7 command files updated, full multi-account support working end-to-end.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v3.0-ROADMAP.md
@.planning/phases/11-multi-account/11-02-PLAN.md
@.planning/phases/11-multi-account/11-03-PLAN.md

**Tech stack available:** Go, Cobra CLI
**Established patterns:** Every command calls auth.NewGmailService(ctx) — needs to become auth.NewGmailService(ctx, GetAccountEmail())
**Constraining decisions:**
- Plan 11-02: NewGmailService signature is now (ctx, account string)
- Plan 11-03: GetAccountEmail() returns --account flag value or GSUITE_ACCOUNT env var or ""
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update all command files to pass account parameter</name>
  <files>cmd/messages.go, cmd/threads.go, cmd/labels.go, cmd/drafts.go, cmd/search.go, cmd/send.go, cmd/whoami.go</files>
  <action>
In every RunE function across all 7 command files, replace:
```go
service, err := auth.NewGmailService(ctx)
```
With:
```go
service, err := auth.NewGmailService(ctx, GetAccountEmail())
```

This is a mechanical one-line change per call site. Files and approximate call counts:
- cmd/messages.go — 4 run functions (runMessagesList, runMessagesGet, runMessagesModify, runGetAttachment)
- cmd/threads.go — 2 run functions (runThreadsList, runThreadsGet)
- cmd/labels.go — 4 run functions (runLabelsList, runLabelsGet, runLabelsCreate, runLabelsDelete)
- cmd/drafts.go — 6 run functions (runDraftsList, runDraftsGet, runDraftsCreate, runDraftsUpdate, runDraftsSend, runDraftsDelete)
- cmd/search.go — 1 run function (runSearch)
- cmd/send.go — 1 run function (runSend)
- cmd/whoami.go — 1 run function (runWhoami)

Total: ~19 call sites, all identical change.

No other logic changes needed — the account resolution (flag > env > active > single account) is handled inside NewGmailService.
  </action>
  <verify>go build -o gsuite . && ./gsuite whoami --help (should show --account in global flags)</verify>
  <done>All 19 call sites across 7 command files updated to pass GetAccountEmail(). Full multi-account support is wired end-to-end.</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `go build -o gsuite .` succeeds without errors
- [ ] `grep -r "NewGmailService(ctx)" cmd/` returns NO matches (all should be `NewGmailService(ctx, GetAccountEmail())`)
- [ ] `grep -r "NewGmailService(ctx, GetAccountEmail())" cmd/` returns all 19 call sites
- [ ] `./gsuite whoami --help` shows --account in inherited flags
- [ ] `./gsuite messages list --help` shows --account in inherited flags

End-to-end test (manual):
- [ ] `gsuite login` with first account works, creates accounts.json and tokens/<email>.json
- [ ] `gsuite login` with second account works, adds to accounts.json
- [ ] `gsuite accounts list` shows both accounts with * on active
- [ ] `gsuite accounts switch <other>` changes active
- [ ] `gsuite whoami` shows the active account
- [ ] `gsuite whoami --account <first>` shows the first account
- [ ] `gsuite accounts remove <other>` removes account and token
- [ ] `gsuite logout` removes active account
</verification>

<success_criteria>
- All commands use multi-account auth API
- --account flag works on every command
- Full multi-account lifecycle works end-to-end
- Phase 11 complete — v3.0 Multi-Account milestone done
</success_criteria>

<output>
After completion, create `.planning/phases/11-multi-account/11-04-SUMMARY.md`
Then update:
- `.planning/ROADMAP.md` — add v3.0 milestone entry
- `.planning/MILESTONES.md` — add v3.0 milestone summary
</output>
