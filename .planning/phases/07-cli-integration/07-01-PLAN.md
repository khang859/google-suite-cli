---
phase: 07-cli-integration
plan: 01
type: execute
depends_on: []
files_modified: [cmd/login.go, cmd/root.go, cmd/whoami.go, cmd/messages.go, cmd/threads.go, cmd/search.go, cmd/send.go, cmd/drafts.go, cmd/labels.go]
---

<objective>
Add `login` command for OAuth2 browser-based authentication and make `--user` optional for OAuth2 users across all commands.

Purpose: Complete the v1.1 OAuth2 milestone — users with OAuth2 client credentials can `gsuite login` to authenticate, then use all commands without `--user` flag.
Output: Working `login` command, all commands work with both service account (requires `--user`) and OAuth2 (no `--user` needed) flows.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-oauth2-core/05-01-SUMMARY.md
@.planning/phases/06-auth-dispatcher/06-01-SUMMARY.md

# Key source files:
@internal/auth/auth.go
@internal/auth/oauth2.go
@internal/auth/token.go
@cmd/root.go
@cmd/whoami.go

**Tech stack available:** Go, Cobra CLI, golang.org/x/oauth2, google.golang.org/api/gmail/v1
**Established patterns:** Cobra subcommand pattern, GetCredentialsFile()/GetUserEmail() getters, auth.Config struct, auth.NewGmailService dispatcher
**Constraining decisions:**
- [Phase 5]: OAuth2 PKCE flow implemented in internal/auth/oauth2.go, token stored at ~/.config/gsuite/token.json
- [Phase 6]: Auth dispatcher in auth.go auto-detects credential type, UserEmail validation only for service account path, OAuth2 path returns "Run 'gsuite login' first" error when no token cached
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add login command and logout command</name>
  <files>cmd/login.go</files>
  <action>
Create cmd/login.go with two Cobra commands:

**`gsuite login`:**
- Load credentials via auth.LoadCredentials (using auth.Config from GetCredentialsFile())
- Extract OAuth2 client creds via auth.extractOAuth2ClientCreds — BUT this is unexported. Instead, use the same pattern: call auth.NewOAuth2Config needs clientID/clientSecret. Since extractOAuth2ClientCreds is unexported, export it as auth.ExtractOAuth2ClientCreds (rename in auth.go).
- Actually, simpler approach: add a new exported function `auth.Login(ctx, credJSON)` in auth.go that handles the full login flow internally:
  1. Calls detectCredentialType — if service_account, return error "login is only for OAuth2 client credentials, service accounts authenticate automatically"
  2. Calls extractOAuth2ClientCreds to get clientID, clientSecret
  3. Creates NewOAuth2Config, calls Authenticate(ctx) to get token
  4. Calls SaveToken(token) to persist
  5. Returns the user's email (by creating a temporary Gmail service and calling GetProfile("me"))
- The login command's RunE: load credentials, call auth.Login(ctx, credJSON), print "Logged in as {email}" or error.

**`gsuite logout`:**
- Remove the token file at auth.TokenPath()
- Print "Logged out — token removed"
- If token doesn't exist, print "Not logged in"

Both commands should NOT require --user flag.
  </action>
  <verify>go build -o gsuite . succeeds, ./gsuite login --help shows usage, ./gsuite logout --help shows usage</verify>
  <done>login command triggers OAuth2 browser flow and saves token, logout removes token file, both build without errors</done>
</task>

<task type="auto">
  <name>Task 2: Remove --user guards from all command files</name>
  <files>cmd/whoami.go, cmd/messages.go, cmd/threads.go, cmd/search.go, cmd/send.go, cmd/drafts.go, cmd/labels.go</files>
  <action>
In every command's RunE function, remove the `--user` empty check guard. The pattern to replace in ALL 18 occurrences across 7 files:

```go
user := GetUserEmail()
// ... credentials setup ...
if user == "" {
    return fmt.Errorf("--user flag required to specify email to impersonate")
}
```

Replace with just passing GetUserEmail() into auth.Config.UserEmail — the auth dispatcher already handles the logic:
- Service account path validates UserEmail internally and returns clear error
- OAuth2 path ignores UserEmail entirely

So in each RunE, just remove the `if user == ""` block. Keep `user := GetUserEmail()` since it's still used in auth.Config{UserEmail: user}. The auth layer handles validation.

Additionally, update --user flag description in root.go init():
- Old: `"Email of user to impersonate"`
- New: `"Email of user to impersonate (required for service account, ignored for OAuth2)"`

Update root command Long description to mention both auth methods:
- Replace the service-account-only description with one that mentions both service account and OAuth2 browser-based auth.
  </action>
  <verify>go build -o gsuite . succeeds with no errors. grep -r "flag required to specify email" cmd/ returns zero results.</verify>
  <done>All 18 --user guard blocks removed from 7 command files. --user flag description updated. Root help text mentions both auth methods.</done>
</task>

<task type="auto">
  <name>Task 3: Verify end-to-end build and help output</name>
  <files>none (verification only)</files>
  <action>
Run final verification:
1. `go build -o gsuite .` — must succeed
2. `./gsuite --help` — must show updated description mentioning both auth methods
3. `./gsuite login --help` — must show login usage
4. `./gsuite logout --help` — must show logout usage
5. `./gsuite messages list --help` — must NOT mention --user as required
6. `go vet ./...` — must pass with no issues
  </action>
  <verify>All 6 verification commands pass</verify>
  <done>Binary builds, all help output correct, go vet clean</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `go build -o gsuite .` succeeds
- [ ] `go vet ./...` passes
- [ ] `./gsuite login --help` shows OAuth2 login usage
- [ ] `./gsuite logout --help` shows logout usage
- [ ] `grep -r "flag required to specify email" cmd/` returns nothing
- [ ] `./gsuite --help` mentions both service account and OAuth2 auth
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No build errors or vet warnings
- login command performs OAuth2 PKCE flow and saves token
- logout command removes token
- All 7 command files no longer require --user for OAuth2 users
- Phase 7 complete — v1.1 OAuth2 Support milestone complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-cli-integration/07-01-SUMMARY.md`
</output>
