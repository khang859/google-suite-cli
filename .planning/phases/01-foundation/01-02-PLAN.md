---
phase: 01-foundation
plan: 02
type: execute
depends_on: ["01-01"]
files_modified: [cmd/root.go, internal/auth/auth.go, internal/gmail/client.go]
---

<objective>
Implement service account authentication with flexible credential handling.

Purpose: Enable Gmail API access via service account with domain-wide delegation, supporting both environment variable and file path credential sources.
Output: Auth module that loads credentials and creates authenticated Gmail service client.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-01-SUMMARY.md

**Auth requirements:**
- Service account JSON credentials (not OAuth user flow)
- Domain-wide delegation to impersonate user
- Credential source: GOOGLE_CREDENTIALS env var (JSON content) OR --credentials-file flag (path)
- Must set Subject (impersonated user email) for domain delegation

**Google API patterns:**
- Use `golang.org/x/oauth2/google` for JWT config
- Use `google.golang.org/api/gmail/v1` for Gmail service
- JWT config needs: Email, PrivateKey, Scopes, Subject, TokenURL
- Scopes for full Gmail access: gmail.GmailModifyScope (read/write) or individual scopes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Google API dependencies</name>
  <files>go.mod, go.sum</files>
  <action>
    Install required packages:
    - `go get google.golang.org/api/gmail/v1`
    - `go get golang.org/x/oauth2/google`

    Run `go mod tidy` after.
  </action>
  <verify>`go mod verify` passes, go.mod contains google.golang.org/api and golang.org/x/oauth2</verify>
  <done>Dependencies installed and verified</done>
</task>

<task type="auto">
  <name>Task 2: Create auth module with flexible credential loading</name>
  <files>internal/auth/auth.go</files>
  <action>
    Create internal/auth/auth.go with:

    1. Config struct: CredentialsFile (string), CredentialsJSON ([]byte), UserEmail (string for impersonation)

    2. LoadCredentials(cfg Config) ([]byte, error) function:
       - If cfg.CredentialsJSON is set, use it directly
       - Else if cfg.CredentialsFile is set, read file
       - Else check GOOGLE_CREDENTIALS env var for JSON content
       - Else check GOOGLE_APPLICATION_CREDENTIALS env var for file path
       - Return error if no credentials found

    3. NewGmailService(ctx context.Context, cfg Config) (*gmail.Service, error) function:
       - Call LoadCredentials to get JSON
       - Parse JSON to extract service account email and private key
       - Create jwt.Config with:
         - Email: from JSON
         - PrivateKey: from JSON
         - Scopes: []string{gmail.GmailModifyScope} (full read/write)
         - Subject: cfg.UserEmail (REQUIRED for domain delegation)
         - TokenURL: google.JWTTokenURL
       - Create http.Client from jwt config
       - Create and return gmail.NewService with the client

    Use google.JWTConfigFromJSON for easier parsing - it handles the JSON structure.

    IMPORTANT: Subject field is required for domain-wide delegation. Without it, the service account cannot access user mailboxes.
  </action>
  <verify>`go build ./...` succeeds, no import errors</verify>
  <done>Auth module compiles, exports LoadCredentials and NewGmailService functions</done>
</task>

<task type="auto">
  <name>Task 3: Add global auth flags to root command</name>
  <files>cmd/root.go</files>
  <action>
    Add persistent flags to root command:
    - --credentials-file, -c: Path to service account JSON file
    - --user, -u: Email of user to impersonate (required for operations)

    Store in package-level variables for use by subcommands.

    Example:
    ```go
    var (
        credentialsFile string
        userEmail       string
    )

    func init() {
        rootCmd.PersistentFlags().StringVarP(&credentialsFile, "credentials-file", "c", "", "Path to service account JSON credentials")
        rootCmd.PersistentFlags().StringVarP(&userEmail, "user", "u", "", "Email of user to impersonate")
    }
    ```

    Also add getter functions GetCredentialsFile() and GetUserEmail() for subcommands to access.
  </action>
  <verify>`./gsuite --help` shows --credentials-file and --user flags</verify>
  <done>Root command has credential flags visible in help</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build -o gsuite .` succeeds
- [ ] `./gsuite --help` shows --credentials-file and --user flags
- [ ] internal/auth package compiles without errors
- [ ] `go vet ./...` passes
</verification>

<success_criteria>

- All tasks completed
- Auth module created with credential loading logic
- Root command has auth flags
- Code compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
