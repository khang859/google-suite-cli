---
phase: 01-foundation
plan: 03
type: execute
depends_on: ["01-02"]
files_modified: [cmd/whoami.go]
---

<objective>
Verify Gmail API connection with a test command.

Purpose: Prove the auth layer works end-to-end by making a real Gmail API call.
Output: "whoami" command that shows authenticated user's email profile.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md

**Verification approach:**
- Use Users.GetProfile API (simplest read operation)
- Returns email address and messages total
- Proves: credentials load, JWT works, domain delegation works, API access works
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create whoami command</name>
  <files>cmd/whoami.go</files>
  <action>
    Create cmd/whoami.go with "whoami" subcommand that:

    1. Gets credentials file and user email from root flags (use the getter functions)
    2. Creates auth.Config with the values
    3. Calls auth.NewGmailService(ctx, cfg)
    4. Calls service.Users.GetProfile("me").Do()
    5. Prints result:
       ```
       Email: user@example.com
       Messages Total: 12345
       Threads Total: 6789
       ```

    Handle errors clearly:
    - No credentials: "Error: no credentials provided. Use --credentials-file or set GOOGLE_CREDENTIALS env var"
    - No user: "Error: --user flag required to specify email to impersonate"
    - Auth failure: "Error: authentication failed: <details>"
    - API error: "Error: Gmail API error: <details>"

    Register with rootCmd.AddCommand(whoamiCmd) in init().
  </action>
  <verify>`go build -o gsuite .` succeeds, `./gsuite whoami --help` shows command help</verify>
  <done>whoami command compiles and shows in help</done>
</task>

<task type="auto">
  <name>Task 2: Test with real credentials (if available)</name>
  <files>N/A (manual verification)</files>
  <action>
    Document how to test:

    1. Create .env.example file showing required variables:
       ```
       # Option 1: JSON content in env var
       GOOGLE_CREDENTIALS='{"type":"service_account",...}'

       # Option 2: File path
       # Use --credentials-file flag or GOOGLE_APPLICATION_CREDENTIALS env var

       # Required: User to impersonate
       # gsuite --user user@yourdomain.com whoami
       ```

    2. Add to README.md (create if doesn't exist) with:
       - What this tool does
       - Prerequisites (service account with domain-wide delegation)
       - Quick start with whoami command
       - Available commands

    If user has credentials available, test:
    ```bash
    ./gsuite --credentials-file /path/to/creds.json --user user@domain.com whoami
    ```

    Expected output: Email and message counts, or clear error message.
  </action>
  <verify>.env.example exists with credential documentation, README.md exists with usage instructions</verify>
  <done>Documentation files created with clear setup instructions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `go build -o gsuite .` succeeds
- [ ] `./gsuite whoami --help` shows command usage
- [ ] `./gsuite whoami` without credentials shows helpful error
- [ ] `./gsuite whoami --user test@example.com` without credentials shows credentials error
- [ ] .env.example documents credential options
- [ ] README.md has usage instructions
- [ ] `go vet ./...` passes
</verification>

<success_criteria>

- All tasks completed
- whoami command exists and handles errors gracefully
- Documentation explains setup requirements
- Phase 1 complete: CLI foundation with auth ready for feature commands
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
